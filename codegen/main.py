import os
from pathlib import Path

import astunparse
import black
from isort import SortImports
from codegen.rammel import parse_raml_file
from codegen.schema_gen import SchemaModuleGenerator
from codegen.types_gen import TypesModuleGenerator


def generate_types_module(types):
    generator = TypesModuleGenerator()
    for resource in types:
        generator.add_type_definition(resource)
    return generator.get_module_node()


def generate_schemas_module(types):
    generator = SchemaModuleGenerator()
    for resource in types:
        generator.add_type_definition(resource)
    return generator.get_module_node()


def generate():
    raml = parse_raml_file("../commercetools-api-reference/api.raml")
    types = raml["types"].types.values()

    path = os.path.join("src", "commercetools")
    try:
        os.makedirs(path)
    except FileExistsError:
        pass

    # Generate types.py
    module_ast = generate_types_module(types)
    filename = os.path.join(path, "types.py")
    write_module(filename, module_ast)

    # Generate schemas.py
    module_ast = generate_schemas_module(types)
    filename = os.path.join(path, "schemas.py")
    write_module(filename, module_ast)


def write_module(filename, ast):
    content = astunparse.unparse(ast)
    with open(filename, "w") as fh:
        fh.write("# DO NOT EDIT! This file is automatically generated\n")
        fh.write(content)
    reformat_code(filename)


def reformat_code(filename):
    SortImports(filename)

    src = Path(filename)
    report = black.Report()
    black.reformat_one(
        src=src,
        line_length=88,
        fast=False,
        write_back=black.WriteBack.YES,
        mode=black.FileMode.AUTO_DETECT,
        report=report,
    )
